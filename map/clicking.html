<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Clicking Demo</title>
    <link rel="shortcut icon" href="vi.favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
      integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
      crossorigin=""/>
    <link rel="stylesheet" href="../libraries/leaflet-distance-marker.css">
    <link rel="stylesheet" href="../libraries/L.Control.Zoomslider.css">
    <style media="screen">
      body {padding: 0; margin: 0;}
      #map {width: 100%; height: calc(100vh - 18px); cursor: inherit;}
      .toolbar {text-align: center;}
      .toolbar .menu-item {padding: 5px 10px; background-color: #d2d2d2;}
      .toolbar .menu-item:hover {cursor: pointer;}
      .toolbar .menu-item.active {color: white;}
      .toolbar .tab-a.active {background-color: red;}
      .toolbar .tab-b.active {background-color: green;}
      .toolbar .tab-c.active {background-color: blue;}
    </style>
  </head>
  <body>
    <div class="toolbar">
      <span class="menu-item tab-a active" data-tabname="a">A</span>
      <span class="menu-item tab-b" data-tabname="b">B</span>
      <span class="menu-item tab-c" data-tabname="c">C</span>
      <span class="menu-item" data-toolbar-actions="undo">Undo</span>
    </div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
      integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
      crossorigin=""></script>
    <script src="../libraries/leaflet.geometryutil.js" charset="utf-8"></script>
    <script src="../libraries/leaflet-draggable-polyline.js" charset="utf-8"></script>
    <script src="../libraries/leaflet-distance-marker.js" charset="utf-8"></script>
    <script src="../libraries/L.Control.Zoomslider.js" charset="utf-8"></script>
    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>
    <script type="text/javascript">
      L.Polyline.prototype.lengthInKm = function () {
        var totalDistance = 0; // In meter
        var points = this._latlngs;
        for (i = 0; i < points.length - 1; i++) {
          currentPoint = new L.latLng(points[i].lat, points[i].lng);
          nextPoint = new L.latLng(points[i + 1].lat, points[i + 1].lng);
          totalDistance += currentPoint.distanceTo(nextPoint);
        }
        return (totalDistance / 1000).toFixed(1);
      }
    </script>
    <script type="text/javascript">
      // var LAT = 16.0669554, LNG = 108.2137157, Z = 16;
      var LAT = 35.68949391611575, LNG = 139.6917173266411, Z = 16;
      var DEFAULT_POS = new L.LatLng(LAT, LNG);
      var map = L.map('map', {zoomControl: false}).setView(DEFAULT_POS, Z);
      // L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
      //   attribution: '&copy; Son Tran',
      //   maxZoom: 20,
      //   id: 'mapbox.streets'
      // }).addTo(map);
      L.tileLayer('https://{s}.mapion.co.jp/m2/tile/{z}/{x}/{y}.png?usr=atlas_org', {
        attribution: '&copy; Son Tran',
        maxZoom: 19,
        minZoom: 6,
        subdomains: ['cm01', 'cm02']
      }).addTo(map);
      L.marker(DEFAULT_POS, {title: "Your position!"}).addTo(map);
      // L.polyline([[35.71732, 139.63554], [35.69362, 139.75519]], {distanceMarkers: {lazy: false}}).addTo(map);
      map.addControl(new L.Control.Zoomslider());
      L.control.scale().addTo(map);
    </script>
    <script type="text/javascript">
      var polyline = null;
      var color = "red";
      var points = [];
      var lastMarker = null;
      var polylineA = null;
      var polylineB = null;
      var polylineC = null;
      var pointsA = [];
      var pointsB = [];
      var pointsC = [];
      var isClickOnLine = false;
      var isDragingPolyline = false;
      var ctrlHolding = false;

      $(function() {
        $(document).on("keydown", function(e) {
          ctrlHolding = detectControlKey(e);
        });

        $(document).on("keyup", function(e) {
          ctrlHolding = false;
        });

        map.on("click", function(event) {
          if (ctrlHolding) {
            alert("OK ve tu do di...");
            return 0;
          }

          if (isClickOnLine || isDragingPolyline) {
            isClickOnLine = false;
            return false;
          }
          var routeTab = getRouteTab();
          var newPoint = new L.latLng(event.latlng);
          console.log("new point: " + newPoint);
          switch (routeTab) {
            case "a":
              color = "red";
              polyline = polylineA;
              points = pointsA;
              break;
            case "b":
              color = "green";
              polyline = polylineB;
              points = pointsB;
              break;
            case "c":
              color = "blue";
              polyline = polylineC;
              points = pointsC;
              break;
          }
          points.push(newPoint);
          if (polyline) {
            polyline.addLatLng(newPoint);
            L.popup()
              .setLatLng(newPoint)
              .setContent(polyline.lengthInKm() + "km")
              .openOn(map);
          } else {
            polyline = L.polyline(points, {
              distanceMarkers: {lazy: true},
              color: color,
              weight: 4,
              opacity: 0.9,
              edit_with_drag: true,
              vertices: {
                first: true,
                last: true,
                middle: true,
                insert: true,
                destroy: true
              },
              distance: 5
            }).addTo(map);
            polyline.on("click", polylineClickHandler);
            polyline.on('editDragStart', function(e) {
              isDragingPolyline = true;
            }).on('editDrag', function(e) {
            }).on("editDragEnd", function(e) {
              setTimeout(function() {
                isDragingPolyline = false;
              }, 50);
            });
          }
          if (isNearBounders(event, map)) {
            map.panTo(newPoint);
          }
          lastMarker = L.marker(newPoint, {draggable: true}).addTo(map);
          lastMarker
            .on('dragstart', dragStartHandler)
            .on('drag', dragHandler)
            .on('dragend', dragEndHandler);

          switch (routeTab) {
            case "a":
              polylineA = polyline;
              pointsA = points;
              break;
            case "b":
              polylineB = polyline;
              pointsB = points;
              break;
            case "c":
              polylineC = polyline;
              pointsC = points;
              break;
          }
          return event;
        });
      });
    </script>
    <script type="text/javascript">
      $(document).ready(function() {
        $(".menu-item").on("click", function(e) {
          $(".menu-item.active").removeClass("active");
          switch (getRouteTab()) {
            case "a":
              color = "red";
              break;
            case "b":
              color = "green";
              break;
            case "c":
              color = "blue";
              break;
          }
          $(this).addClass("active");
        });

        $('[data-toolbar-actions="undo"]').on("click", undo);
        $(window).on("keydown", function(e) {
          if (detectUndoByKeyboard(e)) {
            undo(e);
          }
        });
      });
    </script>
    <script type="text/javascript">
      function getRouteTab() {
        return $(".menu-item.active").data("tabname");
      }

      function isNearBounders(event, map) {
        var OFFSET = 100;
        var X = event.containerPoint.x;
        var Y = event.containerPoint.y;
        var MAX_X = map.getSize().x;
        var MAX_Y = map.getSize().y;
        return X < OFFSET || Y < OFFSET || (X > MAX_X - OFFSET) || (Y > MAX_Y - OFFSET)
      }

      function dragStartHandler(e) {
        var latlngs = polyline.getLatLngs();
        var latlng = this.getLatLng();
        for (var i = 0; i < latlngs.length; i++) {
          if (latlng.equals(latlngs[i])) {
            this.polylineLatlng = i;
          }
        }
      }

      function dragHandler(e) {
        var latlngs = polyline.getLatLngs();
        var latlng = this.getLatLng();
        latlngs.splice(this.polylineLatlng, 1, latlng); // Replace this.polylineLatlng by latlng
        polyline.setLatLngs(latlngs);
      }

      function dragEndHandler(e) {
        delete this.polylineLatlng;
      }

      function detectUndoByKeyboard(event) {
        var Z_KEY = 90;
        return event.keyCode == Z_KEY && event.ctrlKey;
      }

      function undo(e) {
        var routeTab = getRouteTab();
        polyline.remove();
        lastMarker.remove();
        points.pop();
        if (polyline) {
          polyline = L.polyline(points, {color: color, weight: 4, opacity: 0.9}).addTo(map);
          return e;
        } else {
          return false;
        }
      }

      function polylineClickHandler(e) {
        isClickOnLine = true;
        var newPoint = new L.latLng(e.latlng);
        var points = e.target._latlngs;
        var nearestPoints = getNearestPoles(points, newPoint);
        var index = points.indexOf(nearestPoints[1]);
        points.splice(index, 0, newPoint);
        maker = L.marker(newPoint, {draggable: true}).addTo(map);
        maker
          .on('dragstart', dragStartHandler)
          .on('drag', dragHandler)
          .on('dragend', dragEndHandler);
      }

      function getNearestPoles(points, point) {
        var DELTA = 0.001;
        var result = [];
        for (var i = 0; i < points.length - 1; i++) {
          var pointA = points[i];
          var pointB = points[i + 1];
          if (L.GeometryUtil.belongsSegment(point, pointA, pointB, DELTA)) {
            result.push(pointA, pointB);
            break; // Get the first segment which contains the point.
          }
        }
        return result;
      }

      function detectMacintosh() {
        return navigator.userAgent.toUpperCase().indexOf("MAC") > -1;
      }

      function detectControlKey(event) {
        var MAC_CMD_KEYS = 91;
        return detectMacintosh() ? event.keyCode == MAC_CMD_KEYS : event.ctrlKey;
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Bản đồ</title>
    <link rel="shortcut icon" href="vi.favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
      integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
      crossorigin=""/>
    <style media="screen">
      body {padding: 0; margin: 0;}
      #map {width: 100%; height: calc(100vh - 18px); cursor: inherit; text-align: center;}
      .toolbar {text-align: center;}
      .toolbar .menu-item {padding: 5px 10px; background-color: #d2d2d2;}
      .toolbar .menu-item:hover {cursor: pointer;}
      .toolbar .menu-item.active {color: white;}
      .toolbar .tab-a.active {background-color: red;}
      .toolbar .tab-b.active {background-color: green;}
      .toolbar .tab-c.active {background-color: blue;}
      #center-point {
        font-size: 20px;
        color: red;
        text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
        position: fixed;
        left: calc(50% - 5px);
        top: calc(50% - 8px);
        z-index: 999;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <span class="menu-item tab-a active" data-tabname="a">A</span>
      <span class="menu-item tab-b" data-tabname="b">B</span>
      <span class="menu-item tab-c" data-tabname="c">C</span>
      <span class="menu-item" data-toolbar-actions="undo">Undo</span>
    </div>
    <span id="center-point">+</span>
    <div id="map">
      <img src="https://cdn.dribbble.com/users/503653/screenshots/3143656/fluid-loader.gif" alt="Loading..."
        style="padding-top: calc(50vh - 50px); height: 100px;">
    </div>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
      integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
      crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.6.1/mousetrap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
    <script src="../libraries/leaflet.geometryutil.js" charset="utf-8"></script>
    <script src="../libraries/leaflet-draggable-polyline.js" charset="utf-8"></script>
    <script src="../libraries/pather-src.js" charset="utf-8"></script>
    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>
    <script type="text/javascript">
      L.Polyline.prototype.lengthInKm = function () {
        var totalDistance = 0; // In meter
        var points = this._latlngs;
        for (i = 0; i < points.length - 1; i++) {
          totalDistance += points[i].distanceTo(points[i + 1]);
        }
        return (totalDistance / 1000).toFixed(1);
      }
    </script>
    <script type="text/javascript">
      var ctrlHolding = false;
      var mouseTracking = null;
      var LAT, LNG, DEFAULT_POS, map, polyline, currentPosition;
      var Z = 19;
      var polyline = L.polyline({color: "red", weight: 4, opacity: 0.9});

      $(document).ready(function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(initMap);
        } else {
          initMap();
        }
      });
    </script>
    <script type="text/javascript">
      function initMap(position) {
        if (position === undefined) {
          LAT = 16.0669554;
          LNG = 108.2137157;
        } else {
          LAT = position.coords.latitude;
          LNG = position.coords.longitude;
        }
        DEFAULT_POS = new L.LatLng(LAT, LNG);
        map = L.map('map', {
          doubleClickZoom: false,
          scrollWheelZoom: "center"
        }).setView(DEFAULT_POS, Z);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
          attribution: '&copy; Son Tran',
          maxZoom: 20,
          id: 'mapbox.streets'
        }).addTo(map);
        currentPosition = L.marker(DEFAULT_POS, {title: "Your position!"}).addTo(map);
        polyline.addTo(map);

        var mousePressed = false;
        map.on("mousedown", function(event) {
          if (detectCtrlKey(event, false)) {
            map.dragging.disable();
            mousePressed = true;
          }
        }).on("mousemove", function(event) {
          if (detectCtrlKey(event, false) && mousePressed) {
            addLatLngToPolyline(event);
          }
        }).on("mouseup", function(event) {
          mousePressed = false;
          map.dragging.enable();
        });
      }
    </script>
    <script type="text/javascript">
    </script>
    <script type="text/javascript">
      function getRouteTab() {
        return $(".menu-item.active").data("tabname");
      }

      function isNearBounders(event, map) {
        var OFFSET = 100;
        var X = event.containerPoint.x;
        var Y = event.containerPoint.y;
        var MAX_X = map.getSize().x;
        var MAX_Y = map.getSize().y;
        return X < OFFSET || Y < OFFSET || (X > MAX_X - OFFSET) || (Y > MAX_Y - OFFSET)
      }

      function dragStartHandler(e) {
        var latlngs = polyline.getLatLngs();
        var latlng = this.getLatLng();
        for (var i = 0; i < latlngs.length; i++) {
          if (latlng.equals(latlngs[i])) {
            this.polylineLatlng = i;
          }
        }
      }

      function dragHandler(e) {
        var latlngs = polyline.getLatLngs();
        var latlng = this.getLatLng();
        latlngs.splice(this.polylineLatlng, 1, latlng); // Replace this.polylineLatlng by latlng
        polyline.setLatLngs(latlngs);
      }

      function dragEndHandler(e) {
        delete this.polylineLatlng;
      }

      function detectUndoByKeyboard(event) {
        var Z_KEY = 90;
        return event.keyCode == Z_KEY && event.ctrlKey;
      }

      function undo(e) {
        var routeTab = getRouteTab();
        polyline.remove();
        lastMarker.remove();
        points.pop();
        if (polyline) {
          polyline = L.polyline(points, {color: color, weight: 4, opacity: 0.9}).addTo(map);
          return e;
        } else {
          return false;
        }
      }

      function polylineClickHandler(e) {
        isClickOnLine = true;
        var newPoint = new L.latLng(e.latlng);
        var points = e.target._latlngs;
        var nearestPoints = getNearestPoles(points, newPoint);
        var index = points.indexOf(nearestPoints[1]);
        points.splice(index, 0, newPoint);
        maker = L.marker(newPoint, {draggable: true}).addTo(map);
        maker
          .on('dragstart', dragStartHandler)
          .on('drag', dragHandler)
          .on('dragend', dragEndHandler);
      }

      function getNearestPoles(points, point) {
        var DELTA = 0.001;
        var result = [];
        for (var i = 0; i < points.length - 1; i++) {
          var pointA = points[i];
          var pointB = points[i + 1];
          if (L.GeometryUtil.belongsSegment(point, pointA, pointB, DELTA)) {
            result.push(pointA, pointB);
            break; // Get the first segment which contains the point.
          }
        }
        return result;
      }

      function detectMacintosh() {
        return navigator.userAgent.toUpperCase().indexOf("MAC") > -1;
      }

      function detectCtrlKey(event, isOriginalEvent) {
        isOriginalEvent = isOriginalEvent === undefined ? true : isOriginalEvent;
        event = isOriginalEvent ? event : event.originalEvent;
        return detectMacintosh() ? event.metaKey : event.ctrlKey;
      }

      function addLatLngToPolyline(event) {
        polyline.addLatLng(event.latlng);
      }
    </script>
  </body>
</html>

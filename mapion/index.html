<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
    <style media="screen">
      body {margin: 0;}
      #mapid {height: 100vh; cursor: unset;}
      #center-point {
        font-size: 20px;
        color: red;
        text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
        position: fixed;
        left: calc(50% - 5px);
        top: calc(50% - 11px);
        z-index: 999;
      }
    </style>
  </head>
  <body>
    <span id="center-point">+</span>
    <div id="mapid"></div>
    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
     integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
     crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
    <script type="text/javascript">
      var zoomControl = L.Control.extend({
        options: {
          position: 'topright'
        },
        onAdd: function (map) {
          var div = L.DomUtil.create('div', 'zoom-controller');
          if (!ImageResources) return null;
          var zin = ImageResources.getImg("zoomin");
          var zot = ImageResources.getImg("zoomout");
          div.appendChild(zin);
          div.appendChild(zot);
          div.style.cssText = "width:50px; height:100px;";
          zin.style.position = "absolute";
          zin.style.top = "0px";
          zot.style.position = "absolute";
          zot.style.top = "50px";
          if(L.Browser.touch){
            zin.addEventListener("touchstart", function(e){e.stopPropagation();map.zoomIn();},false);
            zot.addEventListener("touchstart", function(e){e.stopPropagation();map.zoomOut();},false);
          } else {
            zin.addEventListener("mousedown", function(e){e.stopPropagation();map.zoomIn();},false);
            zot.addEventListener("mousedown", function(e){e.stopPropagation();map.zoomOut();},false);
          };
          map.addEventListener('zoomend', function(){
            var num = map.getZoom();
            if (num===6) zot.style.opacity = 0.5;
            else zot.style.opacity = 1.0;
            if (num===19) zin.style.opacity = 0.5;
            else zin.style.opacity = 1.0;
          },false);
          div.style.zIndex = 0xFFFFFF;
          return div;
        }
        });
        var scaleControl = L.Control.extend({
        options: {
          position: 'bottomleft'
        },
        onAdd: function (map) {
          var div = L.DomUtil.create('div', 'scale-controller');
          if (!ImageResources) return null;
          for (var i=5;i<20;i++) {
            var key1 = "ruler"+i;
            var key2 = "_"+key1;
            var img = ImageResources.getImg(key1);
            img.style.cssText = "position:absolute; display:none;";
            div[key2] = img;
            div.appendChild(img);
          };
          map.addEventListener('zoomend', function(){
            var num = map.getZoom();
            for (var i=5;i<20;i++) {
              var key = "_ruler"+i;
              if (i==num) {
                div[key].style.display = "block";
              } else {
                div[key].style.display = "none";
              }
            };
          },false);
          div.style.cssText = "width:150px; height:33px; margin-bottom:0px";
          div.style.zIndex = 0xFFFFFF;
          return div;
        }
        });
        var currentLocControl = L.Control.extend({
        options: {
          position: 'topright'
        },
        onAdd: function (map) {
          var div = L.DomUtil.create('div', 'currentLoc-controller');
          if (!ImageResources) return null;
          var reroute = ImageResources.getImg("here");
          div.setAttribute("id", "func_here");
          div.appendChild(reroute);
          div.style.cssText = "width:50px; height:50px;";
          reroute.style.position = "absolute";
          reroute.style.top = "0px";
          div.style.zIndex = 0xFFFFFF;
          return div;
        }
        });
        var rerouteControl = L.Control.extend({
        options: {
          position: 'topright'
        },
        onAdd: function (map) {
          var div = L.DomUtil.create('div', 'reroute-controller');
          if (!ImageResources) return null;
          var reroute = ImageResources.getImg("reroute");
          div.setAttribute("id", "menu_reroute");
          div.appendChild(reroute);
          div.style.cssText = "width:50px; height:50px;";
          reroute.style.position = "absolute";
          reroute.style.top = "0px";
          div.style.zIndex = 0xFFFFFF;
          return div;
        }
      });

      L.Polyline.prototype.lengthInKm = function () {
        var metros_totales_ruta = 0;
        var coordenadas_iniciales = null;
        var array_coordenadas_polilinea = this._latlngs;
        for (i = 0; i < array_coordenadas_polilinea.length - 1; i++) {
          coordenadas_iniciales = array_coordenadas_polilinea[i];
          metros_totales_ruta  += coordenadas_iniciales.distanceTo(array_coordenadas_polilinea[i + 1]);
        }
        return (metros_totales_ruta / 1000).toFixed(1);
      }
    </script>
    <script type="text/javascript">
      var LAT = 35.65484, LON = 139.75481;
      var map = L.map('mapid').setView([LAT, LON], 16);
      L.tileLayer('https://{s}.mapion.co.jp/m2/tile/{z}/{x}/{y}.png?usr=atlas_org', {
        maxZoom: 19,
        minZoom: 6,
        subdomains: ['cm01', 'cm02']
      }).addTo(map);
      L.control.scale({metric: true, imperial: false}).addTo(map);
      // L.control.attribution({
      //   prefix: false,
      //   position: 'bottomright'
      // }).addAttribution('<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>｜© Mapion | Son Tran').addTo(map);

      currentPosMaker = L.marker([16.0668238, 108.2129243], {
        draggable: true,
        title: "Your current position",
        riseOnHover: true,
      });
      currentPosMaker.on("dblclick", function() {
        alert("Hi there!");
      });
      currentPosMaker.addTo(map);

      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);
      var drawControl = new L.Control.Draw({
         edit: {featureGroup: drawnItems}
      });
      map.addControl(drawControl);

      // Pan the map to a new center
      // map.on("click", function() {
      //   LAT += 0.1;
      //   LON += 0.1;
      //   map.panTo(new L.LatLng(LAT, LON));
      // });

      var polyline = null;
      var points = [];
      map.on("click", function(event) {
        var newPoint = event.latlng;
        points.push(newPoint);
        if (polyline) {
          polyline.addLatLng(newPoint);
          // map.fitBounds(polyline.getBounds()); // Zoom in to fit the polyline.
          // L.circle(newPoint, 100).addTo(map);
        } else {
          polyline = L.polyline(points, {color: 'red', weight: 4, opacity: 0.9}).addTo(map);
          var startMaker = new L.marker(newPoint).addTo(map);          
          // L.circle(newPoint, 100).addTo(map);
        }
        if (isNearBounders(event, map)) {
          map.panTo(newPoint);
        }
        var aux_meters = polyline.lengthInKm();
        console.log("Distance: " + aux_meters + "km");
        return event;
      });
    </script>
    <script type="text/javascript">
      function isNearBounders(event, map) {
        var OFFSET = 100;
        var X = event.containerPoint.x;
        var Y = event.containerPoint.y;
        var MAX_X = map.getSize().x;
        var MAX_Y = map.getSize().y;
        return X < OFFSET || Y < OFFSET || (X > MAX_X - OFFSET) || (Y > MAX_Y - OFFSET)
      }
    </script>
  </body>
</html>
